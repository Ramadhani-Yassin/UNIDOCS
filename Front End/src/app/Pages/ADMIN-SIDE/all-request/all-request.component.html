<app-admin-nav></app-admin-nav>
<section id="content" [class.sidebar-collapsed]="!(sidebarService.isOpen$ | async)">
  <!-- MAIN -->
  <main>
    <div class="head-title">
      <div class="left">
        <h1>All Letter Requests</h1>
        <ul class="breadcrumb">
          <li>
            <a href="#" style="text-decoration: none;">All Requests</a>
          </li>
          <li><i class="bx bx-chevron-right"></i></li>
          <li>
            <a class="active" href="#" style="text-decoration: none;">Home</a>
          </li>
        </ul>
      </div>
    </div>

    <div class="table-data">
      <div class="order">
        <div class="head">
          <h3>All Letters</h3>
        <div class="search-filter" style="margin-bottom: 16px;">
          <i class="bx bx-search"></i>
          <input
            type="text"
            placeholder="Search letter requests..."
            [(ngModel)]="localSearchTerm"
            (input)="onLocalSearchChange()"
            style="width: 250px; margin-right: 8px;"
          />
        </div>
        </div>
        <!-- Modal Overlay for Update -->
        <div *ngIf="isUpdating" class="modal-overlay">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="spinner"></div>
              <div class="modal-text" style="font-weight:600;">
                We are working on updates. Please wait...
              </div>
            </div>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Student</th>
              <th>Letter Type</th>
              <th>Request Date</th>
              <th>Status</th>
              <th>Admin Comment</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let request of filteredLetterRequests; let i = index">
              <td>{{ request.fullName }}</td>
              <td>{{ request.letterType }}</td>
              <td>{{ formatDate(request.requestDate) }}</td>
              <td class="status-cell" style="min-width: 160px;">
                <!-- Show badge if not editing -->
                <span
                  *ngIf="editingStatusIndex !== i"
                  class="status-badge"
                  [ngClass]="{
                    'pending': request.status === 'PENDING',
                    'approved': request.status === 'APPROVED',
                    'declined': request.status === 'DECLINED'
                  }"
                  (click)="setEditingStatus(i)"
                  style="cursor:pointer"
                  title="Click to change status"
                >
                  {{ request.status | titlecase }}
                </span>
                <!-- Show dropdown if editing -->
                <select
                  *ngIf="editingStatusIndex === i"
                  [(ngModel)]="request.status"
                  (blur)="saveStatus(request, i)"
                  (change)="saveStatus(request, i)"
                  autofocus
                >
                  <option *ngFor="let s of statuses" [value]="s">{{ s | titlecase }}</option>
                </select>
              </td>
              <td>
                <input [(ngModel)]="request.adminComment" placeholder="Add comment" />
              </td>
              <td>
                <button (click)="updateStatus(request)">Update</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>
  <!-- MAIN -->
</section>